From d9a8d270362ed506e1e06d4a67efe482a9a16715 Mon Sep 17 00:00:00 2001
From: Zongchun Yu <zongchun.yu@nxp.com>
Date: Wed, 29 Apr 2020 12:04:11 +0800
Subject: [PATCH] Add ls1021atwr OTA support

Signed-off-by: Zongchun Yu <zongchun.yu@nxp.com>
---
 board/freescale/ls1021atwr/ls1021atwr.c | 63 +++++++++++++++++++++++++
 configs/ls1021atwr_nor_defconfig        |  1 +
 include/configs/ls1021atwr.h            |  1 +
 3 files changed, 65 insertions(+)

diff --git a/board/freescale/ls1021atwr/ls1021atwr.c b/board/freescale/ls1021atwr/ls1021atwr.c
index 01ba1bc962..20837fb46d 100644
--- a/board/freescale/ls1021atwr/ls1021atwr.c
+++ b/board/freescale/ls1021atwr/ls1021atwr.c
@@ -89,6 +89,69 @@ struct cpld_data {
 	u8 rev2;		/* Reserved */
 };
 
+struct OTA_parameter
+{
+       char status;
+       char str[0x200 - 1];
+};
+
+int ota_sdboot_check(void)
+{
+       struct mmc *mmc;
+       uint blk_start, blk_cnt;
+       unsigned long offset, size;
+       struct OTA_parameter data;
+       int dev = 0;
+       char platform[10];
+
+       offset  = 0x3F00000;
+       size    = 0x200;
+       mmc = find_mmc_device(dev);
+       if(mmc == NULL)
+               return 0;
+       if (mmc_init(mmc))
+               return 0;
+       struct blk_desc *desc = mmc_get_blk_desc(mmc);
+       blk_start   = ALIGN(offset, mmc->read_bl_len) / mmc->read_bl_len;
+       blk_cnt     = ALIGN(size, mmc->read_bl_len) / mmc->read_bl_len;
+       blk_dread(desc, blk_start, blk_cnt, (uchar *)&data);
+
+       if( strstr(data.str, "ls1021a") == NULL ){
+               printf("sd card is not authenticated\n");
+               return 0;
+       }
+
+       printf("status=%c\n",data.status);
+       switch(data.status)
+       {
+               case '0':
+                       break;
+               case '1':
+                       data.status = '2';
+                       blk_dwrite(desc, blk_start, blk_cnt, (uchar *)&data);
+                       break;
+               case '2':
+                       data.status = '3';
+                       blk_dwrite(desc, blk_start, blk_cnt, (uchar *)&data);
+                       return 0;
+                       break;
+               default:
+                       return 0;
+                       break;
+       }
+       return 1;
+}
+
+int last_stage_init(void)
+{
+       if(ota_sdboot_check())
+               env_set("bootcmd","run sdboot");
+       /* enable watchdog and set timeout to 60s */
+       //writew( 0x3478, WDOG1_BASE_ADDR);
+       return 0;
+}
+
+
 #if !defined(CONFIG_QSPI_BOOT) && !defined(CONFIG_SD_BOOT_QSPI)
 static void cpld_show(void)
 {
diff --git a/configs/ls1021atwr_nor_defconfig b/configs/ls1021atwr_nor_defconfig
index 41688263d1..45ab98289a 100644
--- a/configs/ls1021atwr_nor_defconfig
+++ b/configs/ls1021atwr_nor_defconfig
@@ -2,6 +2,7 @@ CONFIG_ARM=y
 CONFIG_TARGET_LS1021ATWR=y
 CONFIG_SYS_TEXT_BASE=0x60100000
 CONFIG_AHCI=y
+CONFIG_LAST_STAGE_INIT=y
 CONFIG_DISTRO_DEFAULTS=y
 CONFIG_NR_DRAM_BANKS=1
 CONFIG_FIT=y
diff --git a/include/configs/ls1021atwr.h b/include/configs/ls1021atwr.h
index 2616f4aa5c..03b4db6e57 100644
--- a/include/configs/ls1021atwr.h
+++ b/include/configs/ls1021atwr.h
@@ -505,5 +505,6 @@
 
 #include <asm/fsl_secure_boot.h>
 #define CONFIG_SYS_BOOTM_LEN	(64 << 20) /* Increase max gunzip size */
+#define CONFIG_LAST_STAGE_INIT
 
 #endif
-- 
2.17.1

