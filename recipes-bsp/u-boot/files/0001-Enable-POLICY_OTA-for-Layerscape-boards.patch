From fd834c89b72723e9c4fc6aaadaa1c5a95e4c53ab Mon Sep 17 00:00:00 2001
From: "mengkun.chen" <mengkun.chen@nxp.com>
Date: Thu, 12 Sep 2019 12:17:52 +0800
Subject: [PATCH] Enable POLICY_OTA for  Layerscape boards

This patch enables POLICY_OTA for ls1012afrwy, ls1012ardb, ls1028ardb,
ls1043ardb, ls1046afrwy, ls1046ardb, ls1088ardb, ls2088ardb and
lx2160ardb.

Signed-off-by: mengkun.chen <mengkun.chen@nxp.com>
---
 arch/arm/cpu/armv8/fsl-layerscape/Kconfig     | 16 +++++++++++
 arch/arm/cpu/armv8/fsl-layerscape/cpu.c       |  4 +++
 board/freescale/ls1012afrdm/ls1012afrdm.c     |  1 +
 board/freescale/ls1012ardb/ls1012ardb.c       |  1 +
 board/freescale/ls1043ardb/ls1043ardb.c       |  1 +
 board/freescale/ls1046afrwy/ls1046afrwy.c     |  1 +
 board/freescale/ls1046ardb/ls1046ardb.c       |  1 +
 board/freescale/ls1088a/ls1088a.c             |  1 +
 board/freescale/ls2080ardb/ls2080ardb.c       |  1 +
 board/freescale/lx2160a/lx2160a.c             |  1 +
 configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig |  3 ++
 configs/ls1012afrwy_tfa_defconfig             |  2 ++
 configs/ls1012ardb_tfa_SECURE_BOOT_defconfig  |  5 ++++
 configs/ls1012ardb_tfa_defconfig              |  2 ++
 configs/ls1028ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/ls1028ardb_tfa_defconfig              |  1 +
 configs/ls1043ardb_tfa_SECURE_BOOT_defconfig  |  3 +-
 configs/ls1043ardb_tfa_defconfig              |  1 +
 configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig |  3 +-
 configs/ls1046afrwy_tfa_defconfig             |  1 +
 configs/ls1046ardb_tfa_SECURE_BOOT_defconfig  |  3 +-
 configs/ls1046ardb_tfa_defconfig              |  1 +
 configs/ls1088ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/ls1088ardb_tfa_defconfig              |  1 +
 configs/ls2088ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/ls2088ardb_tfa_defconfig              |  1 +
 configs/lx2160ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/lx2160ardb_tfa_defconfig              |  1 +
 drivers/net/pfe_eth/pfe_firmware.c            | 41 +++++++++++++++++++++------
 include/configs/ls1012afrwy.h                 | 14 +++++++++
 include/configs/ls1012ardb.h                  | 15 ++++++++++
 include/configs/ls1028a_common.h              |  8 ++++++
 include/configs/ls1043a_common.h              |  7 +++++
 include/configs/ls1046afrwy.h                 |  7 +++++
 include/configs/ls1046ardb.h                  |  7 +++++
 include/configs/ls1088ardb.h                  | 14 +++++++++
 include/configs/ls2080ardb.h                  | 13 +++++++++
 include/configs/lx2160a_common.h              | 13 +++++++++
 38 files changed, 188 insertions(+), 11 deletions(-)

diff --git a/arch/arm/cpu/armv8/fsl-layerscape/Kconfig b/arch/arm/cpu/armv8/fsl-layerscape/Kconfig
index f011a62..938d266 100644
--- a/arch/arm/cpu/armv8/fsl-layerscape/Kconfig
+++ b/arch/arm/cpu/armv8/fsl-layerscape/Kconfig
@@ -615,3 +615,19 @@ config TFABOOT
        help
          Enabling this will make a U-Boot binary that is capable of being
          booted via TFA.
+
+config POLICY_OTA
+       bool "Support OTA"
+       default n
+       help
+         Enabling this will make a U-Boot binary that supports OTA.
+
+config SYS_PFE_FW_LENGTH
+       bool "PFE firmware length"
+       depends on ARCH_LS1012A && POLICY_OTA
+       default n
+
+config SYS_PFE_FW_ADDR
+       bool "PFE firmware address"
+       depends on ARCH_LS1012A && POLICY_OTA
+       default n
diff --git a/arch/arm/cpu/armv8/fsl-layerscape/cpu.c b/arch/arm/cpu/armv8/fsl-layerscape/cpu.c
index 3e2a24f..663db34 100644
--- a/arch/arm/cpu/armv8/fsl-layerscape/cpu.c
+++ b/arch/arm/cpu/armv8/fsl-layerscape/cpu.c
@@ -737,6 +737,10 @@ enum boot_src __get_boot_src(u32 porsr1)
 	if (CONFIG_IS_ENABLED(SYS_FSL_ERRATUM_A010539) && !rcw_src)
 		src = BOOT_SOURCE_QSPI_NOR;
 
+#ifdef CONFIG_POLICY_OTA
+       src = BOOT_SOURCE_SD_MMC;
+#endif
+
 	debug("%s: src 0x%x\n", __func__, src);
 	return src;
 }
diff --git a/board/freescale/ls1012afrdm/ls1012afrdm.c b/board/freescale/ls1012afrdm/ls1012afrdm.c
index b4c611e..5b63859 100644
--- a/board/freescale/ls1012afrdm/ls1012afrdm.c
+++ b/board/freescale/ls1012afrdm/ls1012afrdm.c
@@ -61,6 +61,7 @@ int checkboard(void)
 		break;
 	}
 #endif
+	printf("EdgeScale Bootstrap U-Boot\n");
 
 	return 0;
 }
diff --git a/board/freescale/ls1012ardb/ls1012ardb.c b/board/freescale/ls1012ardb/ls1012ardb.c
index f648a90..f4b0155 100644
--- a/board/freescale/ls1012ardb/ls1012ardb.c
+++ b/board/freescale/ls1012ardb/ls1012ardb.c
@@ -84,6 +84,7 @@ int checkboard(void)
 
 	puts("Board: LS1012A2G5RDB ");
 #endif
+	printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/board/freescale/ls1043ardb/ls1043ardb.c b/board/freescale/ls1043ardb/ls1043ardb.c
index fbd9a26..d5ab5c2 100644
--- a/board/freescale/ls1043ardb/ls1043ardb.c
+++ b/board/freescale/ls1043ardb/ls1043ardb.c
@@ -180,6 +180,7 @@ int checkboard(void)
 	puts("SERDES Reference Clocks:\n");
 	sd1refclk_sel = CPLD_READ(sd1refclk_sel);
 	printf("SD1_CLK1 = %s, SD1_CLK2 = %s\n", freq[sd1refclk_sel], freq[0]);
+	printf("EdgeScale Bootstrap U-Boot\n");
 
 	return 0;
 }
diff --git a/board/freescale/ls1046afrwy/ls1046afrwy.c b/board/freescale/ls1046afrwy/ls1046afrwy.c
index ed64ac3..2b84e91 100644
--- a/board/freescale/ls1046afrwy/ls1046afrwy.c
+++ b/board/freescale/ls1046afrwy/ls1046afrwy.c
@@ -128,6 +128,7 @@ int checkboard(void)
 	else
 		puts("QSPI\n");
 	printf("SD1_CLK1 = %s, SD1_CLK2 = %s\n", freq[0], freq[1]);
+	printf("EdgeScale Bootstrap U-Boot\n");
 
 	return 0;
 }
diff --git a/board/freescale/ls1046ardb/ls1046ardb.c b/board/freescale/ls1046ardb/ls1046ardb.c
index 0a73fe8..3fb463a 100644
--- a/board/freescale/ls1046ardb/ls1046ardb.c
+++ b/board/freescale/ls1046ardb/ls1046ardb.c
@@ -61,6 +61,7 @@ int checkboard(void)
 	puts("SERDES Reference Clocks:\n");
 	sd1refclk_sel = CPLD_READ(sd1refclk_sel);
 	printf("SD1_CLK1 = %s, SD1_CLK2 = %s\n", freq[sd1refclk_sel], freq[0]);
+	printf("EdgeScale Bootstrap U-Boot\n");
 
 	return 0;
 }
diff --git a/board/freescale/ls1088a/ls1088a.c b/board/freescale/ls1088a/ls1088a.c
index 053421d..caa8c56 100644
--- a/board/freescale/ls1088a/ls1088a.c
+++ b/board/freescale/ls1088a/ls1088a.c
@@ -312,6 +312,7 @@ int checkboard(void)
 	printf("Clock1 = %sMHz ", freq[clock]);
 	clock = (sw >> 0) & 3;
 	printf("Clock2 = %sMHz\n", freq[clock]);
+	printf("EdgeScale Bootstrap U-Boot\n");
 
 	return 0;
 }
diff --git a/board/freescale/ls2080ardb/ls2080ardb.c b/board/freescale/ls2080ardb/ls2080ardb.c
index a36e256..7f0558b 100644
--- a/board/freescale/ls2080ardb/ls2080ardb.c
+++ b/board/freescale/ls2080ardb/ls2080ardb.c
@@ -130,6 +130,7 @@ int checkboard(void)
 	puts("\nSERDES2 Reference : ");
 	printf("Clock1 = 100MHz ");
 	printf("Clock2 = 100MHz\n");
+	printf("EdgeScale Bootstrap U-Boot\n");
 
 	return 0;
 }
diff --git a/board/freescale/lx2160a/lx2160a.c b/board/freescale/lx2160a/lx2160a.c
index eff5d9f..cdf1a58 100644
--- a/board/freescale/lx2160a/lx2160a.c
+++ b/board/freescale/lx2160a/lx2160a.c
@@ -374,6 +374,7 @@ int checkboard(void)
 	puts("SERDES2 Reference: Clock1 = 100MHz Clock2 = 100MHz\n");
 	puts("SERDES3 Reference: Clock1 = 100MHz Clock2 = 100MHz\n");
 #endif
+	printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig b/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig
index 46a8fa0..721decc 100644
--- a/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig
@@ -27,6 +27,8 @@ CONFIG_CMD_USB=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-frwy"
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
 CONFIG_SATA_CEVA=y
@@ -54,3 +56,4 @@ CONFIG_USB_XHCI_DWC3=y
 CONFIG_RSA=y
 CONFIG_CMD_SETEXPR=y
 CONFIG_RSA_SOFTWARE_EXP=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1012afrwy_tfa_defconfig b/configs/ls1012afrwy_tfa_defconfig
index 3b3b0cc..3ebf217 100644
--- a/configs/ls1012afrwy_tfa_defconfig
+++ b/configs/ls1012afrwy_tfa_defconfig
@@ -27,6 +27,7 @@ CONFIG_CMD_USB=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-frwy"
+CONFIG_ENV_IS_IN_MMC=y
 CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
@@ -52,3 +53,4 @@ CONFIG_USB=y
 CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig
index 43538d5..f7b2a96 100644
--- a/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig
@@ -31,6 +31,8 @@ CONFIG_CMD_SETEXPR=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-rdb"
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
 CONFIG_SATA_CEVA=y
@@ -40,6 +42,8 @@ CONFIG_DM_SPI_FLASH=y
 CONFIG_SPI_FLASH=y
 # CONFIG_SPI_FLASH_BAR is not set
 # CONFIG_SPI_FLASH_USE_4K_SECTORS is not set
+CONFIG_FSL_PFE=y
+CONFIG_DM_ETH=y
 CONFIG_E1000=y
 CONFIG_PCI=y
 CONFIG_DM_PCI=y
@@ -57,3 +61,4 @@ CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_RSA=y
 CONFIG_RSA_SOFTWARE_EXP=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1012ardb_tfa_defconfig b/configs/ls1012ardb_tfa_defconfig
index f385d4e..b52ca195 100644
--- a/configs/ls1012ardb_tfa_defconfig
+++ b/configs/ls1012ardb_tfa_defconfig
@@ -29,6 +29,7 @@ CONFIG_CMD_USB=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-rdb"
+CONFIG_ENV_IS_IN_MMC=y
 CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
@@ -56,3 +57,4 @@ CONFIG_USB=y
 CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig
index 07507df..e8a4fb0 100644
--- a/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig
@@ -74,3 +74,4 @@ CONFIG_WDT=y
 CONFIG_WDT_SP805=y
 CONFIG_RSA=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1028ardb_tfa_defconfig b/configs/ls1028ardb_tfa_defconfig
index f667867..a5f1b5f 100644
--- a/configs/ls1028ardb_tfa_defconfig
+++ b/configs/ls1028ardb_tfa_defconfig
@@ -76,3 +76,4 @@ CONFIG_USB_XHCI_DWC3=y
 CONFIG_WDT=y
 CONFIG_WDT_SP805=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig
index 637febf..19ac9f7 100644
--- a/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig
@@ -11,7 +11,7 @@ CONFIG_FIT_VERBOSE=y
 CONFIG_OF_BOARD_SETUP=y
 CONFIG_BOOTDELAY=10
 CONFIG_USE_BOOTARGS=y
-CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 mtdparts=60000000.nor:2m@0x100000(nor_bank0_uboot),40m@0x1100000(nor_bank0_fit),7m(nor_bank0_user),2m@0x4100000(nor_bank4_uboot),40m@0x5100000(nor_bank4_fit),-(nor_bank4_user);7e800000.flash:1m(nand_uboot),1m(nand_uboot_env),20m(nand_fit);spi0.0:1m(uboot),5m(kernel),1m(dtb),9m(file_system)"
+CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500"
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_IMLS=y
 CONFIG_CMD_GPT=y
@@ -53,3 +53,4 @@ CONFIG_SPL_RSA=y
 CONFIG_RSA_SOFTWARE_EXP=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
 CONFIG_CMD_SETEXPR=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1043ardb_tfa_defconfig b/configs/ls1043ardb_tfa_defconfig
index 5802902..0e8f201 100644
--- a/configs/ls1043ardb_tfa_defconfig
+++ b/configs/ls1043ardb_tfa_defconfig
@@ -52,3 +52,4 @@ CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig b/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig
index 116c9a2..edd279a3 100644
--- a/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig
@@ -13,7 +13,7 @@ CONFIG_FIT_VERBOSE=y
 CONFIG_OF_BOARD_SETUP=y
 CONFIG_BOOTDELAY=10
 CONFIG_USE_BOOTARGS=y
-CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 mtdparts=1550000.spi:1m(rcw),15m(u-boot),48m(kernel.itb);7e800000.flash:16m(nand_uboot),48m(nand_kernel),448m(nand_free)"
+CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500"
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_GPT=y
 CONFIG_CMD_I2C=y
@@ -54,3 +54,4 @@ CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_RSA=y
 CONFIG_CMD_SETEXPR=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046afrwy_tfa_defconfig b/configs/ls1046afrwy_tfa_defconfig
index 36cdeb0..9b3a6d9 100644
--- a/configs/ls1046afrwy_tfa_defconfig
+++ b/configs/ls1046afrwy_tfa_defconfig
@@ -54,3 +54,4 @@ CONFIG_USB=y
 CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig
index 8cd246a..9b779a7 100644
--- a/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig
@@ -13,7 +13,7 @@ CONFIG_FIT_VERBOSE=y
 CONFIG_OF_BOARD_SETUP=y
 CONFIG_BOOTDELAY=10
 CONFIG_USE_BOOTARGS=y
-CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 mtdparts=1550000.spi-0:1m(rcw),15m(u-boot),48m(kernel.itb);7e800000.flash:16m(nand_uboot),48m(nand_kernel),448m(nand_free)"
+CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500"
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_GPT=y
 CONFIG_CMD_I2C=y
@@ -53,3 +53,4 @@ CONFIG_USB_XHCI_DWC3=y
 CONFIG_RSA=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
 CONFIG_CMD_SETEXPR=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046ardb_tfa_defconfig b/configs/ls1046ardb_tfa_defconfig
index 057ce9d..8f66d2a 100644
--- a/configs/ls1046ardb_tfa_defconfig
+++ b/configs/ls1046ardb_tfa_defconfig
@@ -53,3 +53,4 @@ CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig
index 368daa0..7f56941 100644
--- a/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig
@@ -18,6 +18,7 @@ CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 ramdisk_size=0x3000000 default_hugepagesz=2m hugepagesz=2m hugepages=256"
 # CONFIG_USE_BOOTCOMMAND is not set
 # CONFIG_SPI_FLASH_BAR is not set
+CONFIG_POLICY_OTA=y
 CONFIG_MISC_INIT_R=y
 # CONFIG_DISPLAY_BOARDINFO is not set
 CONFIG_DISPLAY_BOARDINFO_LATE=y
diff --git a/configs/ls1088ardb_tfa_defconfig b/configs/ls1088ardb_tfa_defconfig
index 654ffa9..5ceeb5a 100644
--- a/configs/ls1088ardb_tfa_defconfig
+++ b/configs/ls1088ardb_tfa_defconfig
@@ -71,3 +71,4 @@ CONFIG_DM_GPIO=y
 CONFIG_RTC_PCF2127=y
 CONFIG_I2C_MUX=y
 CONFIG_I2C_MUX_PCA954x=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig b/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig
index 8b4beae..1f23ada 100644
--- a/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig
@@ -17,6 +17,7 @@ CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyS1,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0600 ramdisk_size=0x2000000 default_hugepagesz=2m hugepagesz=2m hugepages=256"
 # CONFIG_USE_BOOTCOMMAND is not set
 # CONFIG_SPI_FLASH_BAR is not set
+CONFIG_POLICY_OTA=y
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_IMLS=y
 CONFIG_CMD_GREPENV=y
diff --git a/configs/ls2088ardb_tfa_defconfig b/configs/ls2088ardb_tfa_defconfig
index ca28366..026545b 100644
--- a/configs/ls2088ardb_tfa_defconfig
+++ b/configs/ls2088ardb_tfa_defconfig
@@ -70,6 +70,7 @@ CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
 CONFIG_DM_I2C=y
 CONFIG_I2C_SET_DEFAULT_BUS_NUM=y
 CONFIG_I2C_DEFAULT_BUS_NUMBER=0
diff --git a/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig b/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig
index e747e62..f7bd67a 100644
--- a/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig
@@ -16,6 +16,7 @@ CONFIG_OF_STDOUT_VIA_ALIAS=y
 CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyAMA0,115200 root=/dev/ram0 earlycon=pl011,mmio32,0x21c0000 ramdisk_size=0x2000000 default_hugepagesz=1024m hugepagesz=1024m hugepages=2 pci=pcie_bus_perf"
 # CONFIG_USE_BOOTCOMMAND is not set
+CONFIG_POLICY_OTA=y
 CONFIG_CMD_GREPENV=y
 CONFIG_CMD_EEPROM=y
 CONFIG_CMD_GPT=y
diff --git a/configs/lx2160ardb_tfa_defconfig b/configs/lx2160ardb_tfa_defconfig
index 07aacf2..be8ad58 100644
--- a/configs/lx2160ardb_tfa_defconfig
+++ b/configs/lx2160ardb_tfa_defconfig
@@ -63,6 +63,7 @@ CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
 CONFIG_DM_I2C=y
 CONFIG_I2C_SET_DEFAULT_BUS_NUM=y
 CONFIG_I2C_DEFAULT_BUS_NUMBER=0
diff --git a/drivers/net/pfe_eth/pfe_firmware.c b/drivers/net/pfe_eth/pfe_firmware.c
index adb2d06..6c802ec 100644
--- a/drivers/net/pfe_eth/pfe_firmware.c
+++ b/drivers/net/pfe_eth/pfe_firmware.c
@@ -15,10 +15,13 @@
 #ifdef CONFIG_CHAIN_OF_TRUST
 #include <fsl_validate.h>
 #endif
+#ifdef CONFIG_POLICY_OTA
+#include <malloc.h>
+#include <mmc.h>
+#endif
 
 #define PFE_FIRMEWARE_FIT_CNF_NAME	"config@1"
 
-static const void *pfe_fit_addr = (void *)CONFIG_SYS_LS_PFE_FW_ADDR;
 
 /*
  * PFE elf firmware loader.
@@ -92,7 +95,7 @@ err:
  * @return 0 on success, a negative value on error
  */
 static int pfe_get_fw(const void **data,
-		      size_t *size, char *fw_name)
+		      size_t *size, char *fw_name, void *pfe_fit_addr)
 {
 	int conf_node_off, fw_node_off;
 	char *conf_node_name = NULL;
@@ -140,7 +143,7 @@ static int pfe_get_fw(const void **data,
  *
  * @return 0 on success, a negative value on error
  */
-static int pfe_fit_check(void)
+static int pfe_fit_check(void *pfe_fit_addr)
 {
 	int ret = 0;
 
@@ -176,20 +179,42 @@ int pfe_firmware_init(void)
 	const void *raw_image_addr;
 	size_t raw_image_size = 0;
 	u8 *pfe_firmware;
-#ifdef CONFIG_CHAIN_OF_TRUST
+#if defined(CONFIG_CHAIN_OF_TRUST) && !defined(CONFIG_POLICY_OTA)
 	uintptr_t pfe_esbc_hdr = 0;
 	uintptr_t pfe_img_addr = 0;
 #endif
 	int ret = 0;
 	int fw_count;
+	void *pfe_fw_addr = NULL;
+
+#ifdef CONFIG_POLICY_OTA
+       int dev = CONFIG_SYS_MMC_ENV_DEV;
+
+       printf("\nPFE firmware on SD_MMC\n");
+       pfe_fw_addr = malloc(CONFIG_SYS_PFE_FW_LENGTH);
+       u32 cnt = CONFIG_SYS_PFE_FW_LENGTH / 512;
+       u32 blk = CONFIG_SYS_PFE_FW_ADDR / 512;
+       struct mmc *mmc = find_mmc_device(CONFIG_SYS_MMC_ENV_DEV);
+
+       if (!mmc) {
+               printf("\nMMC cannot find device for ucode\n");
+       } else {
+               printf("\nMMC read: dev # %u, block # %u, count %u ...\n",
+                      dev, blk, cnt);
+               mmc_init(mmc);
+               (void)blk_dread(mmc_get_blk_desc(mmc), blk, cnt, pfe_fw_addr);
+       }
+#else
+       pfe_fw_addr = (void *)CONFIG_SYS_LS_PFE_FW_ADDR;
+#endif
 
-	ret = pfe_fit_check();
+	ret = pfe_fit_check(pfe_fw_addr);
 	if (ret)
 		goto err;
 
-#ifdef CONFIG_CHAIN_OF_TRUST
+#if defined(CONFIG_CHAIN_OF_TRUST) && !defined(CONFIG_POLICY_OTA)
 	pfe_esbc_hdr = CONFIG_SYS_LS_PFE_ESBC_ADDR;
-	pfe_img_addr = (uintptr_t)pfe_fit_addr;
+	pfe_img_addr = (uintptr_t)pfe_fw_addr;
 	if (fsl_check_boot_mode_secure() != 0) {
 		/*
 		 * In case of failure in validation, fsl_secboot_validate
@@ -214,7 +239,7 @@ int pfe_firmware_init(void)
 		else if (fw_count == 1)
 			pfe_firmware_name = "tmu";
 
-		pfe_get_fw(&raw_image_addr, &raw_image_size, pfe_firmware_name);
+		pfe_get_fw(&raw_image_addr, &raw_image_size, pfe_firmware_name, pfe_fw_addr);
 		pfe_firmware = malloc(raw_image_size);
 		if (!pfe_firmware)
 			return -ENOMEM;
diff --git a/include/configs/ls1012afrwy.h b/include/configs/ls1012afrwy.h
index 12e6437..48370b7 100644
--- a/include/configs/ls1012afrwy.h
+++ b/include/configs/ls1012afrwy.h
@@ -23,6 +23,15 @@
 #define CONFIG_SYS_MEMTEST_START	0x80000000
 #define CONFIG_SYS_MEMTEST_END		0x9fffffff
 
+#ifdef CONFIG_TFABOOT
+#define CONFIG_SYS_MMC_ENV_DEV         0
+
+#ifdef CONFIG_POLICY_OTA
+#define CONFIG_SYS_PFE_FW_LENGTH       0x10000
+#define CONFIG_SYS_PFE_FW_ADDR         0x20000
+#endif
+#endif
+
 #ifndef CONFIG_SPL_BUILD
 #undef BOOT_TARGET_DEVICES
 #define BOOT_TARGET_DEVICES(func) \
@@ -122,8 +131,13 @@
 #undef CONFIG_BOOTCOMMAND
 #ifdef CONFIG_TFABOOT
 #undef QSPI_NOR_BOOTCOMMAND
+#ifdef CONFIG_SECURE_BOOT
+#define QSPI_NOR_BOOTCOMMAND "pfe stop;mmc read 0xa0000000 0x8000 0x17000;"    \
+                       "bootm 0xa0000000;"
+#else
 #define QSPI_NOR_BOOTCOMMAND "pfe stop; run distro_bootcmd; run sd_bootcmd; "\
 			     "env exists secureboot && esbc_halt;"
+#endif
 #else
 #define CONFIG_BOOTCOMMAND "pfe stop; run distro_bootcmd; run sd_bootcmd; "\
 			   "env exists secureboot && esbc_halt;"
diff --git a/include/configs/ls1012ardb.h b/include/configs/ls1012ardb.h
index f6640fa..bd38fbd 100644
--- a/include/configs/ls1012ardb.h
+++ b/include/configs/ls1012ardb.h
@@ -16,6 +16,14 @@
 #define CONFIG_SYS_MEMTEST_START	0x80000000
 #define CONFIG_SYS_MEMTEST_END		0x9fffffff
 
+#ifdef CONFIG_TFABOOT
+#define CONFIG_SYS_MMC_ENV_DEV         0
+
+#ifdef CONFIG_POLICY_OTA
+#define CONFIG_SYS_PFE_FW_LENGTH       0x10000
+#define CONFIG_SYS_PFE_FW_ADDR         0xa00000
+#endif
+#endif
 
 /*
  * I2C IO expander
@@ -115,8 +123,15 @@
 #undef CONFIG_BOOTCOMMAND
 #ifdef CONFIG_TFABOOT
 #undef QSPI_NOR_BOOTCOMMAND
+#ifdef CONFIG_SECURE_BOOT
+#define QSPI_NOR_BOOTCOMMAND "pfe stop;mmc read 0xa0000000 0x8000 0x17000;"    \
+                       "mmc read 0x80000000 0x3000 0x1000;"                    \
+                       "esbc_validate 0x80100000;"                             \
+                       "bootm 0xa0000000;"
+#else
 #define QSPI_NOR_BOOTCOMMAND "pfe stop; run distro_bootcmd; run qspi_bootcmd; "\
 			     "env exists secureboot && esbc_halt;"
+#endif
 #else
 #define CONFIG_BOOTCOMMAND "pfe stop; run distro_bootcmd; run qspi_bootcmd; "\
 			   "env exists secureboot && esbc_halt;"
diff --git a/include/configs/ls1028a_common.h b/include/configs/ls1028a_common.h
index 822e060..59f13c4 100644
--- a/include/configs/ls1028a_common.h
+++ b/include/configs/ls1028a_common.h
@@ -160,9 +160,17 @@
 #define XSPI_NOR_BOOTCOMMAND	\
 	"run xspi_hdploadcmd; run distro_bootcmd; run xspi_bootcmd; " \
 	"env exists secureboot && esbc_halt;;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND \
+       "mmc read 0xa0000000 0x8000 0x17000;"           \
+       "mmc read 0x80000000 0x3000 0x1000;"            \
+       "esbc_validate 0x80100000;"                     \
+       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND	\
 	"run sd_hdploadcmd; run distro_bootcmd;run sd_bootcmd; " \
 	"env exists secureboot && esbc_halt;"
+#endif
 #define SD2_BOOTCOMMAND	\
 	"run emmc_hdploadcmd; run distro_bootcmd;run emmc_bootcmd; " \
 	"env exists secureboot && esbc_halt;"
diff --git a/include/configs/ls1043a_common.h b/include/configs/ls1043a_common.h
index dcdf8f8..ca7bc1a 100644
--- a/include/configs/ls1043a_common.h
+++ b/include/configs/ls1043a_common.h
@@ -310,8 +310,15 @@
 #ifdef CONFIG_TFABOOT
 #define QSPI_NOR_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND "mmc read 0xa0000000 0x8000 0x17000;"           \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND "run distro_bootcmd; run sd_bootcmd; "  \
 			   "env exists secureboot && esbc_halt;"
+#endif
 #define IFC_NOR_BOOTCOMMAND "run distro_bootcmd; run nor_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
 #define IFC_NAND_BOOTCOMMAND "run distro_bootcmd; run nand_bootcmd; "	\
diff --git a/include/configs/ls1046afrwy.h b/include/configs/ls1046afrwy.h
index 727572d..dffe334 100644
--- a/include/configs/ls1046afrwy.h
+++ b/include/configs/ls1046afrwy.h
@@ -225,8 +225,15 @@
 #ifdef CONFIG_TFABOOT
 #define QSPI_NOR_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND "mmc read 0xa0000000 0x8000 0x17000;"   \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND "run distro_bootcmd;run sd_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
+#endif
 #else
 #if defined(CONFIG_QSPI_BOOT)
 #define CONFIG_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
diff --git a/include/configs/ls1046ardb.h b/include/configs/ls1046ardb.h
index fa90953..6a739a8 100644
--- a/include/configs/ls1046ardb.h
+++ b/include/configs/ls1046ardb.h
@@ -216,8 +216,15 @@
 #ifdef CONFIG_TFABOOT
 #define QSPI_NOR_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND "mmc read 0xa0000000 0x8000 0x17000;"   \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND "run distro_bootcmd;run sd_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
+#endif
 #else
 #if defined(CONFIG_QSPI_BOOT)
 #define CONFIG_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
diff --git a/include/configs/ls1088ardb.h b/include/configs/ls1088ardb.h
index 50de658..aa8dbcb 100644
--- a/include/configs/ls1088ardb.h
+++ b/include/configs/ls1088ardb.h
@@ -498,6 +498,19 @@
 		"&& fsl_mc lazyapply dpl 0x80001000;"		\
 		"run distro_bootcmd;run qspi_bootcmd;"		\
 		"env exists secureboot && esbc_halt;"
+
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND                                         \
+               "mmc read 0x80000000 5000 0x800;"               \
+               "mmc read 0x88000000 7000 0x800;"               \
+               "fsl_mc start mc 0x80000000 0x88000000;"        \
+               "mmc read 0x80000000 6800 0x800;"               \
+               "fsl_mc lazyapply dpl 0x80000000;"              \
+               "mmc read 0xa0000000 0x8000 0x17000;"           \
+               "mmc read 0x80000000 0x3000 0x1000;"            \
+               "esbc_validate 0x80100000;"                     \
+               "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND						\
 		"env exists mcinitcmd && mmcinfo; "		\
 		"mmc read 0x80001000 0x6800 0x800; "		\
@@ -507,6 +520,7 @@
 		"&& fsl_mc lazyapply dpl 0x80001000;"		\
 		"run distro_bootcmd;run sd_bootcmd;"		\
 		"env exists secureboot && esbc_halt;"
+#endif
 #else
 #if defined(CONFIG_QSPI_BOOT)
 /* Try to boot an on-QSPI kernel first, then do normal distro boot */
diff --git a/include/configs/ls2080ardb.h b/include/configs/ls2080ardb.h
index ee9b348..622bac9 100644
--- a/include/configs/ls2080ardb.h
+++ b/include/configs/ls2080ardb.h
@@ -525,6 +525,18 @@ unsigned long get_board_sys_clk(void);
 			"env exists secureboot && esbc_halt;"
 
 /* Try to boot an on-SD kernel first, then do normal distro boot */
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND                                                 \
+                       "mmc read 0x80000000 5000 0x800;"               \
+                       "mmc read 0x88000000 7000 0x800;"               \
+                       "fsl_mc start mc 0x80000000 0x88000000;"        \
+                       "mmc read 0x80000000 6800 0x800;"               \
+                       "fsl_mc lazyapply dpl 0x80000000;"              \
+                       "mmc read 0xa0000000 0x8000 0x17000;"           \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND						\
 			"env exists mcinitcmd && env exists secureboot "\
 			"&& mmcinfo && mmc read $load_addr 0x3c00 0x800 " \
@@ -534,6 +546,7 @@ unsigned long get_board_sys_clk(void);
 			"&& fsl_mc lazyapply dpl 0x80d00000; "		\
 			"run distro_bootcmd;run sd_bootcmd; "		\
 			"env exists secureboot && esbc_halt;"
+#endif
 
 /* Try to boot an on-NOR kernel first, then do normal distro boot */
 #define IFC_NOR_BOOTCOMMAND						\
diff --git a/include/configs/lx2160a_common.h b/include/configs/lx2160a_common.h
index e18c8df..74aace9 100644
--- a/include/configs/lx2160a_common.h
+++ b/include/configs/lx2160a_common.h
@@ -277,6 +277,18 @@ int select_i2c_ch_pca9547_sec(unsigned char ch);
 			"run distro_bootcmd;run xspi_bootcmd; "		\
 			"env exists secureboot && esbc_halt;"
 
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND                                         \
+               "mmc read 0x80000000 5000 0x800;"               \
+               "mmc read 0x88000000 7000 0x800;"               \
+               "fsl_mc start mc 0x80000000 0x88000000;"        \
+               "mmc read 0x80000000 6800 0x800;"               \
+               "fsl_mc lazyapply dpl 0x80000000;"              \
+               "mmc read 0xa0000000 0x8000 0x17000;"           \
+               "mmc read 0x80000000 0x3000 0x1000;"            \
+               "esbc_validate 0x80100000;"                     \
+               "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND						\
 		"env exists mcinitcmd && mmcinfo; "		\
 		"mmc read 0x80d00000 0x6800 0x800; "		\
@@ -286,6 +298,7 @@ int select_i2c_ch_pca9547_sec(unsigned char ch);
 		"&& fsl_mc lazyapply dpl 0x80d00000;"		\
 		"run distro_bootcmd;run sd_bootcmd;"		\
 		"env exists secureboot && esbc_halt;"
+#endif
 
 #define BOOT_TARGET_DEVICES(func) \
 	func(USB, usb, 0) \
-- 
2.7.4

